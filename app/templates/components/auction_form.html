<!-- Auction Create/Edit Form Component with Image Upload -->
{% if mode == 'edit' %}
<!-- EDIT FORM - Uses PUT -->
<form
    hx-put="/api/auctions/{{ auction_id }}"
    hx-target="#modal-content"
    hx-swap="outerHTML"
    class="space-y-5"
    onsubmit="return validateForm(event)"
>
{% else %}
<!-- CREATE FORM - Uses POST -->
<form
    hx-post="/api/auctions/create"
    hx-target="#modal-content"
    hx-swap="outerHTML"
    class="space-y-5"
    onsubmit="return validateForm(event)"
>
{% endif %}

    <!-- Error Message -->
    {% if error %}
    <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
        <p class="text-sm text-red-700 font-medium">{{ error }}</p>
    </div>
    {% endif %}

    <!-- Title Field -->
    <div>
        <label for="title" class="block text-sm font-medium text-slate-900 mb-2">
            Auction Title
        </label>
        <input
            type="text"
            id="title"
            name="title"
            required
            maxlength="255"
            value="{% if auction %}{{ auction.title }}{% endif %}"
            placeholder="Enter auction title"
            class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900 focus:border-transparent transition bg-slate-50 placeholder-slate-400"
        />
        <p class="text-xs text-slate-500 mt-1">Max 255 characters</p>
    </div>

    <!-- Content Field -->
    <div>
        <label for="content" class="block text-sm font-medium text-slate-900 mb-2">
            Description
        </label>
        <textarea
            id="content"
            name="content"
            required
            rows="5"
            placeholder="Enter detailed description of the auction item..."
            class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900 focus:border-transparent transition bg-slate-50 placeholder-slate-400 resize-none"
        >{% if auction %}{{ auction.content }}{% endif %}</textarea>
        <p class="text-xs text-slate-500 mt-1">Provide a detailed description</p>
    </div>

    <!-- Image Upload Field -->
    <div>
        <label for="image_upload" class="block text-sm font-medium text-slate-900 mb-2">
            Auction Image
        </label>
        
        <!-- Image Preview -->
        {% if auction and auction.image_path %}
        <div id="image-preview-container" class="mb-3 p-3 bg-slate-100 rounded-lg">
            <img id="image-preview" src="/uploads/{{ auction.image_path }}" alt="Auction image" class="max-w-xs h-auto rounded-lg">
            <p class="text-xs text-slate-600 mt-2">Current image</p>
        </div>
        {% else %}
        <div id="image-preview-container" class="hidden mb-3 p-3 bg-slate-100 rounded-lg">
            <img id="image-preview" alt="Image preview" class="max-w-xs h-auto rounded-lg">
            <p class="text-xs text-slate-600 mt-2">Image preview</p>
        </div>
        {% endif %}
        
        <!-- File Input -->
        <div class="relative">
            <input
                type="file"
                id="image_upload"
                name="image_upload"
                accept=".jpg,.jpeg,.png,.gif,.webp"
                class="hidden"
            />
            <button
                type="button"
                id="upload-btn"
                class="w-full px-4 py-2.5 border-2 border-dashed border-slate-300 rounded-lg hover:border-slate-400 transition bg-slate-50 text-slate-700 font-medium"
                onclick="document.getElementById('image_upload').click()"
            >
                üì∑ Choose Image or Drag & Drop
            </button>
            <input type="hidden" id="image_filename" name="image_filename" value="{% if auction %}{{ auction.image_path }}{% endif %}">
        </div>
        
        <!-- Upload Status -->
        <div id="upload-status" class="hidden mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="flex items-center">
                <div class="animate-spin mr-2">‚è≥</div>
                <span id="status-text" class="text-sm text-blue-700">Uploading image...</span>
            </div>
        </div>
        
        <p class="text-xs text-slate-500 mt-2">Supported: JPG, PNG, GIF, WebP (Max 5MB)</p>
    </div>

    <!-- Form Actions -->
    <div class="flex gap-3 pt-4">
        <button
            type="submit"
            class="flex-1 px-4 py-2.5 bg-slate-900 text-white font-medium rounded-lg hover:bg-slate-800 transition active:scale-95"
        >
            {% if mode == 'edit' %}
            Update Auction
            {% else %}
            Create Auction
            {% endif %}
        </button>
        <button
            type="button"
            onclick="closeModal()"
            class="flex-1 px-4 py-2.5 border border-slate-300 text-slate-900 font-medium rounded-lg hover:bg-slate-50 transition"
        >
            Cancel
        </button>
    </div>
</form>

<script>
    const imageUpload = document.getElementById('image_upload');
    const uploadBtn = document.getElementById('upload-btn');
    const uploadStatus = document.getElementById('upload-status');
    const statusText = document.getElementById('status-text');
    const imageFilename = document.getElementById('image_filename');
    const previewContainer = document.getElementById('image-preview-container');
    const previewImg = document.getElementById('image-preview');

    // Handle file selection
    imageUpload.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleImageUpload(e.target.files[0]);
        }
    });

    // Handle drag and drop
    uploadBtn.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadBtn.classList.add('border-slate-500', 'bg-slate-100');
    });

    uploadBtn.addEventListener('dragleave', () => {
        uploadBtn.classList.remove('border-slate-500', 'bg-slate-100');
    });

    uploadBtn.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadBtn.classList.remove('border-slate-500', 'bg-slate-100');
        
        if (e.dataTransfer.files.length > 0) {
            const file = e.dataTransfer.files[0];
            imageUpload.files = e.dataTransfer.files;
            handleImageUpload(file);
        }
    });

    async function handleImageUpload(file) {
        // Validate file type
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
            alert('Invalid file type. Please upload JPG, PNG, GIF, or WebP');
            return;
        }

        // Validate file size (5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('File too large. Maximum size is 5MB');
            return;
        }

        // Show loading state
        uploadStatus.classList.remove('hidden');
        statusText.textContent = `Uploading ${file.name}...`;

        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/api/auctions/upload-image', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                // Update hidden input with filename
                imageFilename.value = result.filename;

                // Show preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    previewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);

                // Update button text
                uploadBtn.textContent = `‚úì ${file.name} uploaded`;
                uploadBtn.classList.add('border-green-300', 'bg-green-50', 'text-green-700');

                statusText.textContent = 'Image uploaded successfully!';
                statusText.parentElement.classList.add('bg-green-50', 'border-green-200');
                statusText.classList.add('text-green-700');

                setTimeout(() => {
                    uploadStatus.classList.add('hidden');
                }, 2000);
            } else {
                alert('Upload failed: ' + (result.error || 'Unknown error'));
                uploadStatus.classList.add('hidden');
            }
        } catch (error) {
            console.error('Upload error:', error);
            alert('Upload error: ' + error.message);
            uploadStatus.classList.add('hidden');
        }
    }

    function validateForm(event) {
        const title = document.getElementById('title').value.trim();
        const content = document.getElementById('content').value.trim();

        if (!title) {
            event.preventDefault();
            alert('Please enter a title');
            return false;
        }

        if (!content) {
            event.preventDefault();
            alert('Please enter a description');
            return false;
        }

        if (title.length > 255) {
            event.preventDefault();
            alert('Title must be 255 characters or less');
            return false;
        }

        console.log('[FORM_SUBMIT] Form validation passed', {
            mode: '{{ mode }}',
            title: title.substring(0, 50),
            contentLength: content.length,
            image: imageFilename.value || 'none'
        });

        return true;
    }

    // Focus first input for better UX
    document.getElementById('title').focus();
</script>

<style>
    textarea {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
</style>