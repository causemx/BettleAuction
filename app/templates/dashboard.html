{% extends "base.html" %}

{% block title %}Dashboard - FastAPI Auth{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header with logout -->
    <div class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Dashboard</h1>
                <p class="text-gray-600 mt-1">Welcome, <span id="username-display" class="font-semibold text-indigo-600">Guest</span>!</p>
            </div>
            <button
                onclick="logout()"
                class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition"
            >
                Logout
            </button>
        </div>
    </div>

    <!-- Main content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- Profile Card -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- User Info -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">üë§ Your Profile</h3>
                <div id="profile-info" class="space-y-3">
                    <div>
                        <p class="text-sm text-gray-600">Username</p>
                        <p id="profile-username" class="font-semibold text-gray-900">Loading...</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Email</p>
                        <p id="profile-email" class="font-semibold text-gray-900">Loading...</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Role</p>
                        <p id="profile-role" class="font-semibold text-gray-900">
                            <span id="role-badge" class="inline-block px-3 py-1 bg-indigo-100 text-indigo-800 rounded-full text-sm">user</span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Token Info -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">üîê Authentication</h3>
                <div class="space-y-3">
                    <div>
                        <p class="text-sm text-gray-600">Token Status</p>
                        <p id="token-status" class="font-semibold text-green-600">‚úÖ Active</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Token Type</p>
                        <p class="font-semibold text-gray-900">Bearer (JWT)</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Storage</p>
                        <p class="font-semibold text-gray-900">localStorage</p>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">üìä Stats</h3>
                <div class="space-y-3">
                    <div>
                        <p class="text-sm text-gray-600">Last Login</p>
                        <p class="font-semibold text-gray-900" id="last-login">Just now</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Session Duration</p>
                        <p class="font-semibold text-gray-900">30 minutes</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Status</p>
                        <p class="font-semibold text-green-600">‚úÖ Authenticated</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Features Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- API Test -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">üß™ API Test</h3>
                <p class="text-gray-600 text-sm mb-4">Test your authenticated API requests</p>
                <button
                    onclick="testApiCall()"
                    class="w-full px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition"
                >
                    Test API Call
                </button>
                <div id="api-result" class="mt-4 p-3 bg-gray-50 rounded text-sm hidden">
                    <p class="font-semibold text-gray-900 mb-2">Result:</p>
                    <pre id="api-output" class="overflow-x-auto text-xs"></pre>
                </div>
            </div>

            <!-- Token Info -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">üîë Token Details</h3>
                <button
                    onclick="showTokenInfo()"
                    class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition"
                >
                    Show Token Info
                </button>
                <div id="token-info" class="mt-4 p-3 bg-gray-50 rounded text-sm hidden">
                    <p class="font-semibold text-gray-900 mb-2">Token Payload:</p>
                    <pre id="token-payload" class="overflow-x-auto text-xs"></pre>
                </div>
            </div>
        </div>

        <!-- Error Messages -->
        <div id="error-message" class="mt-6"></div>
        <div id="success-message" class="mt-6"></div>
    </div>
</div>

<script>
    // ========================================================================
    // AUTHENTICATION CHECK
    // ========================================================================
    
    window.addEventListener('DOMContentLoaded', () => {
        // Get username from cookie (backend sets this during login)
        const username = getCookie('username');
        
        if (!username) {
            // Not authenticated, redirect to login
            showError('No authentication found. Please login first.');
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
            return;
        }
        
        // Display username
        document.getElementById('username-display').textContent = username;
        document.getElementById('profile-username').textContent = username;
        
        // Fetch user profile info
        fetchUserProfile();
    });

    // ========================================================================
    // HELPER: GET COOKIE VALUE
    // ========================================================================
    
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) {
            return parts.pop().split(';').shift();
        }
        return null;
    }

    // ========================================================================
    // FETCH USER PROFILE
    // ========================================================================
    
    async function fetchUserProfile() {
        try {
            // Call the /api/profile endpoint (no token needed - backend reads from cookie)
            const response = await fetch('/api/profile', {
                method: 'GET',
                headers: {
                    'Content-Type': 'text/html',
                },
                credentials: 'same-origin'  // Include cookies
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    // Not authenticated
                    showError('Your session has expired. Please login again.');
                    setTimeout(() => {
                        logout();
                    }, 2000);
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            // Response is HTML, parse it
            const html = await response.text();
            
            // Extract data from HTML response
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // Get profile info from the HTML
            const usernameElem = tempDiv.querySelector('p') ? tempDiv.textContent : '';
            
            // Parse the HTML to get user info
            const text = html;
            const usernameMatch = text.match(/Username:<\/strong>\s*(\w+)/);
            const emailMatch = text.match(/Email:<\/strong>\s*([^<]+)/);
            const roleMatch = text.match(/Role:<\/[^>]+>[^<]*<span[^>]*>([^<]+)/);
            
            if (emailMatch) {
                document.getElementById('profile-email').textContent = emailMatch[1].trim() || 'N/A';
            }
            
            if (roleMatch) {
                const role = roleMatch[1].trim().toLowerCase();
                document.getElementById('role-badge').textContent = role;
                // Update badge color based on role
                const badge = document.getElementById('role-badge');
                if (role === 'admin') {
                    badge.classList.remove('bg-indigo-100', 'text-indigo-800');
                    badge.classList.add('bg-red-100', 'text-red-800');
                }
            }
            
            showSuccess('Profile loaded successfully!');
        } catch (error) {
            console.error('Error fetching profile:', error);
            showError('Could not load profile: ' + error.message);
        }
    }

    // ========================================================================
    // TEST API CALL
    // ========================================================================
    
    async function testApiCall() {
        try {
            const response = await fetch('/api/profile', {
                method: 'GET',
                headers: {
                    'Content-Type': 'text/html',
                },
                credentials: 'same-origin'
            });
            
            const data = await response.text();
            
            const resultDiv = document.getElementById('api-result');
            const outputDiv = document.getElementById('api-output');
            
            if (response.ok) {
                outputDiv.textContent = data;
                resultDiv.classList.remove('hidden');
                resultDiv.classList.remove('bg-red-50');
                resultDiv.classList.add('bg-green-50');
                showSuccess('API call successful!');
            } else {
                outputDiv.textContent = `Error: ${response.status} ${response.statusText}`;
                resultDiv.classList.remove('hidden');
                resultDiv.classList.add('bg-red-50');
                showError('API call failed with status ' + response.status);
            }
        } catch (error) {
            console.error('API test error:', error);
            showError('API test failed: ' + error.message);
        }
    }

    // ========================================================================
    // SHOW TOKEN INFO
    // ========================================================================
    
    function showTokenInfo() {
        const tokenInfoDiv = document.getElementById('token-info');
        const payloadDiv = document.getElementById('token-payload');
        
        // Token is in HTTP-only cookie, we can't access it from JavaScript
        payloadDiv.textContent = JSON.stringify({
            note: "Token is stored in HTTP-only cookie and cannot be accessed from JavaScript",
            storage: "HTTP-only cookie (secure)",
            accessible: false,
            info: "This is more secure - prevents XSS attacks from stealing your token"
        }, null, 2);
        
        tokenInfoDiv.classList.remove('hidden');
        showSuccess('Token is stored securely in HTTP-only cookie!');
    }

    // ========================================================================
    // LOGOUT
    // ========================================================================
    
    function logout() {
        try {
            // Call logout endpoint to clear cookies on server
            fetch('/logout', {
                method: 'GET',
                credentials: 'same-origin'
            }).then(() => {
                // Redirect to login
                window.location.href = '/login?success=You have been logged out successfully.';
            });
        } catch (error) {
            console.error('Logout error:', error);
            // Still redirect even if fetch fails
            window.location.href = '/login';
        }
    }

    // ========================================================================
    // MESSAGE HANDLERS
    // ========================================================================
    
    function showError(message) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.innerHTML = `
            <div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg flex items-start">
                <svg class="w-5 h-5 mr-3 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
                <span>${message}</span>
            </div>
        `;
    }

    function showSuccess(message) {
        const successDiv = document.getElementById('success-message');
        successDiv.innerHTML = `
            <div class="p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg flex items-start">
                <svg class="w-5 h-5 mr-3 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
                <span>${message}</span>
            </div>
        `;
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            successDiv.innerHTML = '';
        }, 5000);
    }
</script>

{% endblock %}